<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <meta name="theme-color" content="#1a1a1a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Secure Vault">
  <title>Secure Vault</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1a1a1a">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root {
      --primary:#6366f1;--primary-dark:#4f46e5;--secondary:#8b5cf6;
      --bg-primary:#0a0a0a;--bg-secondary:#1a1a1a;--bg-card:#262626;
      --text-primary:#fff;--text-secondary:#a3a3a3;
      --danger:#ef4444;--success:#22c55e;--border:#404040;
    }
    body {
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      background:var(--bg-primary);color:var(--text-primary);
      height:100vh;overflow:hidden;user-select:none;
    }
    .app{height:100vh;display:flex;flex-direction:column}
    .header {
      background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);
      padding:20px 20px 10px;
      padding-top:40px;
      box-shadow:0 4px 20px rgba(0,0,0,0.3);
    }
    .header-content{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .header h1{font-size:24px;font-weight:600}
    .header-actions{display:flex;gap:15px}
    .header-btn {
      background:rgba(255,255,255,0.2);border:none;width:36px;height:36px;
      border-radius:50%;display:flex;align-items:center;justify-content:center;
      cursor:pointer;transition:.3s;
    }
    .header-btn:active{transform:scale(.9);background:rgba(255,255,255,0.3)}
    .search-container{position:relative}
    .search-input {
      width:100%;padding:12px 45px 12px 20px;
      background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);
      border-radius:25px;color:white;font-size:16px;outline:none;transition:.3s;
    }
    .search-input::placeholder{color:rgba(255,255,255,0.5)}
    .search-input:focus {
      background:rgba(255,255,255,0.15);border-color:rgba(255,255,255,0.3);
    }
    .search-icon {
      position:absolute;right:15px;top:50%;transform:translateY(-50%);
      opacity:.5;
    }
    .main-content {
      flex:1;overflow-y:auto;padding:20px;padding-bottom:80px;
    }
    .section{margin-bottom:30px}
    .section-title {
      font-size:14px;color:var(--text-secondary);
      margin-bottom:15px;text-transform:uppercase;letter-spacing:.5px;
    }
    .folders-grid, .documents-grid {
      display:grid;gap:15px;
    }
    .folders-grid{grid-template-columns:repeat(3,1fr)}
    .documents-grid{grid-template-columns:repeat(2,1fr)}
    .folder-card, .document-card {
      background:var(--bg-card);border-radius:16px;padding:15px;
      cursor:pointer;transition:.3s;border:1px solid transparent;
      display:flex;flex-direction:column;align-items:center;gap:10px;
      position:relative;
    }
    .folder-card:active, .document-card:active{transform:scale(.95)}
    .folder-card.vault {
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      border:none;
    }
    .folder-icon, .document-icon {
      display:flex;align-items:center;justify-content:center;
      font-size:24px;width:40px;height:40px;
    }
    .folder-name, .document-name {
      font-size:14px;text-align:center;word-break:break-word;
    }
    .folder-count, .document-meta {
      font-size:12px;color:var(--text-secondary);
    }
    .document-header {
      display:flex;align-items:center;gap:12px;
      margin-bottom:10px;width:100%;
    }
    .document-info{flex:1}
    .document-type {
      position:absolute;bottom:-5px;right:-5px;
      background:var(--primary);color:#fff;font-size:10px;
      padding:2px 5px;border-radius:6px;font-weight:600;
    }
    .document-card.encrypted {
      background:linear-gradient(135deg,rgba(99,102,241,0.1),rgba(139,92,246,0.1));
      border:1px solid rgba(99,102,241,0.3);
    }
    .document-card.encrypted .document-icon {
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      border-radius:12px;
    }
    .bottom-nav {
      position:fixed;bottom:0;left:0;right:0;
      background:var(--bg-secondary);padding:15px;
      display:flex;justify-content:space-around;align-items:center;
      box-shadow:0 -4px 20px rgba(0,0,0,0.3);border-top:1px solid var(--border);
    }
    .nav-btn {
      background:none;border:none;color:var(--text-secondary);
      display:flex;flex-direction:column;align-items:center;gap:5px;
      cursor:pointer;transition:.3s;padding:5px 20px;
    }
    .nav-btn:active{transform:scale(.9)}
    .nav-btn.primary {
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      color:#fff;border-radius:25px;padding:12px 30px;
      flex-direction:row;gap:8px;
      box-shadow:0 4px 15px rgba(99,102,241,0.3);
    }
    .nav-btn-icon{font-size:24px}
    .nav-btn-text{font-size:12px}
    .modal {
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.8);display:none;
      align-items:center;justify-content:center;
      z-index:1000;padding:20px;
    }
    .modal.active{display:flex}
    .modal-content {
      background:var(--bg-secondary);border-radius:20px;
      padding:25px;width:100%;max-width:400px;
      max-height:80vh;overflow-y:auto;position:relative;
    }
    .modal-header {
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:20px;
    }
    .modal-title{font-size:20px;font-weight:600}
    .modal-close {
      background:none;border:none;color:var(--text-secondary);
      font-size:24px;cursor:pointer;
    }
    .form-group{margin-bottom:20px}
    .form-label {
      display:block;margin-bottom:8px;font-size:14px;
      color:var(--text-secondary);
    }
    .form-input {
      width:100%;padding:12px 16px;background:var(--bg-card);
      border:1px solid var(--border);border-radius:12px;
      color:var(--text-primary);font-size:16px;outline:none;
      transition:.3s;
    }
    .form-input:focus {
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(99,102,241,0.1);
    }
    .btn {
      padding:12px 24px;border:none;border-radius:12px;
      font-size:16px;font-weight:500;cursor:pointer;
      transition:.3s;width:100%;
    }
    .btn-primary {
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      color:#fff;
    }
    .btn-secondary {
      background:var(--bg-card);color:var(--text-primary);
      margin-top:10px;
    }
    .btn:active{transform:scale(.98)}
    .file-input-wrapper {
      position:relative;overflow:hidden;display:inline-block;width:100%;
    }
    .file-input {
      position:absolute;left:-9999px;
    }
    .file-input-label {
      display:flex;align-items:center;justify-content:center;gap:10px;
      padding:20px;background:var(--bg-card);
      border:2px dashed var(--border);border-radius:12px;
      cursor:pointer;transition:.3s;
    }
    .file-input-label:hover {
      border-color:var(--primary);
      background:rgba(99,102,241,0.1);
    }
    .pin-container {
      display:flex;gap:15px;justify-content:center;margin:30px 0;
    }
    .pin-input {
      width:60px;height:70px;text-align:center;font-size:28px;
      font-weight:bold;background:var(--bg-card);
      border:2px solid var(--border);border-radius:12px;
      color:var(--text-primary);outline:none;transition:.3s;
      caret-color:transparent;
    }
    .pin-input:focus {
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(99,102,241,0.2);
    }
    .pin-input.filled {background:var(--primary);color:#fff}
    .empty-state {text-align:center;padding:40px}
    .empty-icon {font-size:64px;opacity:.3;margin-bottom:20px}
    .empty-text {color:var(--text-secondary);font-size:16px}
    .toast {
      position:fixed;bottom:100px;left:50%;
      transform:translateX(-50%) translateY(100px);
      background:var(--bg-card);padding:16px 24px;
      border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.3);
      opacity:0;transition:.3s;z-index:2000;
    }
    .toast.show {
      transform:translateX(-50%) translateY(0);opacity:1;
    }
    .context-menu {
      position:fixed;background:var(--bg-secondary);
      border-radius:12px;padding:8px 0;
      box-shadow:0 4px 20px rgba(0,0,0,0.5);
      z-index:3000;display:none;min-width:180px;
    }
    .context-menu.active{display:block}
    .context-menu-item {
      padding:12px 20px;cursor:pointer;
      display:flex;align-items:center;gap:12px;transition:.2s;
    }
    .context-menu-item:hover{background:var(--bg-card)}
    .context-menu-divider {
      height:1px;background:var(--border);margin:8px 0;
    }
    .delete-folder-btn {
      position:absolute;top:5px;right:5px;
      background:var(--danger);border:none;width:24px;height:24px;
      border-radius:50%;color:#fff;cursor:pointer;font-size:16px;
      display:flex;align-items:center;justify-content:center;
      opacity:0;transition:opacity .3s;
    }
    .folder-card:hover .delete-folder-btn{opacity:.8}
    .fullscreen-image {
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.95);display:flex;
      align-items:center;justify-content:center;z-index:4000;
      padding:20px;
    }
    .fullscreen-image img {
      max-width:100%;max-height:100%;object-fit:contain;
    }
    .fullscreen-close {
      position:absolute;top:20px;right:20px;
      background:rgba(255,255,255,0.2);border:none;
      width:40px;height:40px;border-radius:50%;
      color:#fff;font-size:24px;cursor:pointer;
    }
    .loading {
      display:inline-block;width:20px;height:20px;
      border:2px solid rgba(255,255,255,0.3);
      border-radius:50%;border-top-color:#fff;
      animation:spin .8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="header-content">
        <h1>Secure Vault</h1>
        <div class="header-actions">
          <button class="header-btn" onclick="app.showPinModal()"><span>🔒</span></button>
          <button class="header-btn" onclick="app.sortDocuments()"><span>📊</span></button>
        </div>
      </div>
      <div class="search-container">
        <input type="text" class="search-input"
               placeholder="Поиск документов..."
               onkeyup="app.search(this.value)">
        <span class="search-icon">🔍</span>
      </div>
    </div>
    <div class="main-content" id="mainContent"></div>
    <div class="bottom-nav">
      <button class="nav-btn" onclick="app.showNewFolderModal()">
        <span class="nav-btn-icon">📁</span>
        <span class="nav-btn-text">Папка</span>
      </button>
      <button class="nav-btn primary" onclick="app.showUploadModal()">
        <span class="nav-btn-icon">➕</span>
        <span class="nav-btn-text">Добавить</span>
      </button>
      <button class="nav-btn" onclick="app.showMenu()">
        <span class="nav-btn-icon">☰</span>
        <span class="nav-btn-text">Меню</span>
      </button>
    </div>
  </div>

  <div class="context-menu" id="contextMenu">
    <div class="context-menu-item" onclick="app.contextMenuAction('open')">
      <span>👁️</span> Открыть
    </div>
    <div class="context-menu-item" onclick="app.contextMenuAction('download')">
      <span>💾</span> Скачать
    </div>
    <div class="context-menu-item" onclick="app.contextMenuAction('share')">
      <span>📤</span> Поделиться
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" style="color:var(--danger);"
         onclick="app.contextMenuAction('delete')">
      <span>🗑️</span> Удалить
    </div>
  </div>

  <!-- Upload Modal -->
  <div class="modal" id="uploadModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Добавить документ</h2>
        <button class="modal-close"
                onclick="app.closeModal('uploadModal')">✕</button>
      </div>
      <div class="form-group">
        <label class="form-label">Выберите папку</label>
        <select class="form-input" id="folderSelect">
          <option value="">Главная</option>
          <option value="vault">🔐 Сейф</option>
        </select>
      </div>
      <div class="form-group">
        <div class="file-input-wrapper">
          <input type="file" class="file-input" id="fileInput" multiple
                 accept="image/*,.pdf,.txt,.doc,.docx,.xls,.xlsx">
          <label for="fileInput" class="file-input-label">
            <span>📎</span><span>Выберите файлы</span>
          </label>
        </div>
      </div>
      <button class="btn btn-primary" onclick="app.uploadFiles()">
        Загрузить
      </button>
    </div>
  </div>

  <!-- New Folder Modal -->
  <div class="modal" id="newFolderModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Новая папка</h2>
        <button class="modal-close"
                onclick="app.closeModal('newFolderModal')">✕</button>
      </div>
      <div class="form-group">
        <label class="form-label">Название папки</label>
        <input type="text" class="form-input" id="folderName"
               placeholder="Введите название">
      </div>
      <button class="btn btn-primary" onclick="app.createFolder()">
        Создать
      </button>
    </div>
  </div>

  <!-- PIN Modal -->
  <div class="modal" id="pinModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Введите PIN</h2>
        <button class="modal-close"
                onclick="app.closeModal('pinModal')">✕</button>
      </div>
      <div class="pin-container">
        <input type="text" class="pin-input" id="pin1" maxlength="1"
               inputmode="numeric" pattern="[0-9]">
        <input type="text" class="pin-input" id="pin2" maxlength="1"
               inputmode="numeric" pattern="[0-9]">
        <input type="text" class="pin-input" id="pin3" maxlength="1"
               inputmode="numeric" pattern="[0-9]">
        <input type="text" class="pin-input" id="pin4" maxlength="1"
               inputmode="numeric" pattern="[0-9]">
      </div>
      <button class="btn btn-primary" onclick="app.checkPin()">Войти</button>
    </div>
  </div>

  <!-- Menu Modal -->
  <div class="modal" id="menuModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Меню</h2>
        <button class="modal-close"
                onclick="app.closeModal('menuModal')">✕</button>
      </div>
      <button class="btn btn-secondary" onclick="app.exportData()">
        <span>💾</span> Экспорт данных
      </button>
      <button class="btn btn-secondary" onclick="app.showImportModal()">
        <span>📥</span> Импорт данных
      </button>
      <button class="btn btn-secondary" onclick="app.showClearDataModal()">
        <span>🗑️</span> Очистить все данные
      </button>
      <button class="btn btn-secondary" onclick="app.showAbout()">
        <span>ℹ️</span> О приложении
      </button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const app = {
      db: null,
      currentFolder: null,
      vaultUnlocked: false,
      searchQuery: '',
      sortBy: 'date',
      contextMenuTarget: null,

      async init() {
        await this.initDB();
        await this.registerServiceWorker();
        this.render();
        this.setupPinInputs();
        this.setupContextMenu();
      },

      initDB() {
        return new Promise((res, rej) => {
          const req = indexedDB.open('SecureVault', 1);
          req.onerror = () => rej(req.error);
          req.onsuccess = () => {
            this.db = req.result;
            res();
          };
          req.onupgradeneeded = e => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains('documents')) {
              const s = db.createObjectStore('documents', { keyPath: 'id' });
              s.createIndex('folder', 'folder');
              s.createIndex('type', 'type');
              s.createIndex('date', 'date');
            }
            if (!db.objectStoreNames.contains('folders'))
              db.createObjectStore('folders', { keyPath: 'id' });
            if (!db.objectStoreNames.contains('vault'))
              db.createObjectStore('vault', { keyPath: 'id' });
            if (!db.objectStoreNames.contains('settings'))
              db.createObjectStore('settings', { keyPath: 'key' });
          };
        });
      },

      async registerServiceWorker() {
        if ('serviceWorker' in navigator) {
          try { await navigator.serviceWorker.register('sw.js'); }
          catch (e) { console.error('SW failed', e); }
        }
      },

      setupPinInputs() {
        const pins = document.querySelectorAll('.pin-input');
        pins.forEach((inp, i) => {
          inp.addEventListener('input', e => {
            let v = e.target.value.replace(/\D/g,'');
            e.target.value = v ? '•' : '';
            if (v) {
              inp.dataset.value = v;
              inp.classList.add('filled');
              if (i < pins.length - 1) pins[i+1].focus();
              else setTimeout(()=>this.checkPin(),100);
            } else {
              inp.dataset.value = '';
              inp.classList.remove('filled');
            }
          });
          inp.addEventListener('keydown', e => {
            if (e.key === 'Backspace' && !inp.value && i>0) {
              pins[i-1].focus();
              pins[i-1].value = '';
              pins[i-1].dataset.value = '';
              pins[i-1].classList.remove('filled');
            }
          });
        });
      },

      search(q) {
        this.searchQuery = q;
        this.render();
      },

      async render() {
        const content = document.getElementById('mainContent');
        const docs = await this.getDocuments();
        const folders = await this.getFolders();
        const vaultDocs = await this.getVaultDocuments();
        let html = '';

        if (this.currentFolder) {
          html += `
            <div style="margin-bottom:20px;">
              <button onclick="app.goHome()"
                      style="background:var(--bg-card);
                             border:none;
                             padding:10px 20px;
                             border-radius:12px;
                             color:var(--text-primary);
                             cursor:pointer">
                ← На главную
              </button>
            </div>`;
        }

        if (!this.currentFolder) {
          html += `
            <div class="section">
              <h3 class="section-title">Папки</h3>
              <div class="folders-grid">
                <div class="folder-card vault"
                     onclick="app.openVault()"
                     oncontextmenu="app.showFolderMenu(event,'vault')">
                  <div class="folder-icon">🔐</div>
                  <div class="folder-name">Сейф</div>
                  <div class="folder-count">${
                    this.vaultUnlocked ? 'Открыт' : `${vaultDocs.length} файлов`
                  }</div>
                </div>`;
          folders.forEach(f => {
            const c = docs.filter(d=>d.folder===f.id).length;
            html += `
              <div class="folder-card"
                   onclick="app.openFolder('${f.id}')"
                   oncontextmenu="app.showFolderMenu(event,'${f.id}')">
                <button class="delete-folder-btn"
                        onclick="event.stopPropagation();app.deleteFolder('${f.id}')">×</button>
                <div class="folder-icon">📁</div>
                <div class="folder-name">${f.name}</div>
                <div class="folder-count">${c} файлов</div>
              </div>`;  
          });
          html += `</div></div>`;
        }

        let visible = [];
        if (this.searchQuery.trim()) {
          const q = this.searchQuery.toLowerCase();
          const src = this.currentFolder==='vault'?vaultDocs:docs;
          visible = src.filter(d=>d.name.toLowerCase().includes(q));
          if (this.currentFolder==='vault'&&!this.vaultUnlocked) visible=[];
        } else {
          if (this.currentFolder==='vault')
            visible = this.vaultUnlocked?vaultDocs:[];
          else if (this.currentFolder)
            visible = docs.filter(d=>d.folder===this.currentFolder);
          else
            visible = docs.filter(d=>!d.folder);
        }
        visible.sort((a,b)=>
          this.sortBy==='date'?b.date-a.date:
          a.type.localeCompare(b.type)
        );

        if (visible.length) {
          html += `
            <div class="section">
              <h3 class="section-title">Документы</h3>
              <div class="documents-grid">`;
          visible.forEach(doc=>{
            const icon=this.getFileIcon(doc.type);
            const date=new Date(doc.date).toLocaleDateString();
            const enc=(doc.encrypted||this.currentFolder==='vault')?'encrypted':'';
            html+=`
              <div class="document-card ${enc}"
                   onclick="app.openDocument('${doc.id}')"
                   oncontextmenu="app.showDocumentMenu(event,'${doc.id}')">
                <div class="document-header">
                  <div class="document-icon">
                    <span>${icon}</span>
                    <span class="document-type">${doc.type.toUpperCase()}</span>
                  </div>
                  <div class="document-info">
                    <div class="document-name">${doc.name}</div>
                    <div class="document-meta">${date} • ${this.formatFileSize(doc.size)}</div>
                  </div>
                </div>
                <button class="delete-btn"
                        onclick="event.stopPropagation();app.deleteDocument('${doc.id}')">×</button>
              </div>`;
          });
          html+=`</div></div>`;
        } else if (!folders.length && !this.currentFolder) {
          html=`
            <div class="empty-state">
              <div class="empty-icon">📄</div>
              <div class="empty-text">Нет документов</div>
            </div>`;
        }

        content.innerHTML=html;
        this.updateFolderSelector();
      },

      getPinValue(){
        let p='';
        for(let i=1;i<=4;i++){
          p+=document.getElementById('pin'+i).dataset.value||'';
        }
        return p;
      },

      clearPinInputs(){
        for(let i=1;i<=4;i++){
          const el=document.getElementById('pin'+i);
          el.value='';el.dataset.value='';el.classList.remove('filled');
        }
        document.getElementById('pin1').focus();
      },

      async hashPin(pin){
        const enc=new TextEncoder().encode(pin);
        const buf=await crypto.subtle.digest('SHA-256',enc);
        return Array.from(new Uint8Array(buf))
          .map(b=>b.toString(16).padStart(2,'0')).join('');
      },

      async checkPin(){
        const pin=this.getPinValue();
        if(pin.length!==4){ this.showToast('Введите 4 цифры');return; }
        if(pin==='1234'){ this.emergencyWipe();return; }
        const hashed=await this.hashPin(pin);
        const tx=this.db.transaction(['settings'],'readonly');
        const store=tx.objectStore('settings');
        const req=store.get('vaultPin');
        req.onsuccess=async()=>{
          const stored=req.result?.value;
          if(!stored||stored===hashed){
            this.vaultUnlocked=true;
            if(!stored) await this.savePinSetting(hashed);
            this.closeModal('pinModal');
            this.clearPinInputs();
            this.showToast('Сейф открыт');
            this.showVaultContents();
            setTimeout(()=>{
              this.vaultUnlocked=false;
              this.showToast('Сейф заблокирован');
              this.render();
            },60000);
          } else {
            this.showToast('Неверный PIN');
            this.clearPinInputs();
          }
        };
      },

      async exportData(){
        try {
          const folders=await this.getFolders();
          const docs=await this.getDocuments();
          const vault=await this.getVaultDocuments();
          const settings=await this.getSettings();
          const filtered=settings.filter(s=>s.key!=='vaultPin');
          const data={version:1,exported:new Date().toISOString(),
                      folders,documents:docs,vault,settings:filtered};
          const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
          const url=URL.createObjectURL(blob);
          const a=document.createElement('a');
          a.href=url;
          a.download=`vault_backup_${new Date().toISOString().split('T')[0]}.json`;
          a.click();
          URL.revokeObjectURL(url);
          this.showToast('Данные экспортированы (PIN не включен)');
        } catch(e){
          this.showToast('Ошибка экспорта');console.error(e);
        }
      },

      async uploadFiles(){
        const fi=document.getElementById('fileInput');
        const sel=document.getElementById('folderSelect');
        if(!fi.files.length){ this.showToast('Выберите файлы');return; }
        if(sel.value==='vault' && !this.vaultUnlocked){
          this.showToast('Сначала откройте Сейф');return;
        }
        for(const f of fi.files){
          const r=new FileReader();
          r.onload=async e=>{
            const doc={
              id:Date.now()+'_'+Math.random(),
              name:f.name,
              type:this.getFileType(f.name),
              size:f.size,
              data:e.target.result,
              folder:sel.value||null,
              date:Date.now()
            };
            if(sel.value==='vault'){
              doc.encrypted=true;
              const tx=this.db.transaction(['vault'],'readwrite');
              await tx.objectStore('vault').add(doc);
            } else {
              const tx=this.db.transaction(['documents'],'readwrite');
              await tx.objectStore('documents').add(doc);
            }
          };
          r.readAsDataURL(f);
        }
        this.closeModal('uploadModal');
        this.showToast('Файлы загружены');
        setTimeout(()=>this.render(),200);
      },

      async getDocuments(){
        return new Promise((res,rej)=>{
          const tx=this.db.transaction(['documents'],'readonly');
          const req=tx.objectStore('documents').getAll();
          req.onsuccess=()=>res(req.result);
          req.onerror=()=>rej(req.error);
        });
      },

      async getVaultDocuments(){
        return new Promise((res,rej)=>{
          const tx=this.db.transaction(['vault'],'readonly');
          const req=tx.objectStore('vault').getAll();
          req.onsuccess=()=>res(req.result);
          req.onerror=()=>rej(req.error);
        });
      },

      async savePinSetting(val){
        const tx=this.db.transaction(['settings'],'readwrite');
        await tx.objectStore('settings').put({key:'vaultPin',value:val});
      },

      async openDocument(id){
        const tx=this.db.transaction(['documents','vault'],'readonly');
        const dstore=tx.objectStore('documents');
        const req=dstore.get(id);
        req.onsuccess=()=>{
          let doc=req.result;
          if(doc) this.showDocumentPreview(doc);
          else {
            const vstore=tx.objectStore('vault');
            const r2=vstore.get(id);
            r2.onsuccess=()=>{ if(r2.result) this.showDocumentPreview(r2.result); };
          }
        };
      },

      showDocumentPreview(doc){
        const m=document.createElement('div');
        m.className='modal active';
        m.style.zIndex='2000';
        let content='';
        if(['jpg','jpeg','png','gif'].includes(doc.type)){
          content=`
            <img src="${doc.data}" alt="${doc.name}"
                 style="max-width:100%;max-height:400px;object-fit:contain;cursor:pointer"
                 onclick="app.showFullscreenImage('${doc.data}')">
            <p style="text-align:center;color:var(--text-secondary);margin-top:10px;">
              Нажмите для полноэкранного просмотра
            </p>`;
        } else if(doc.type==='pdf'){
          const isMob=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
          if(isMob){
            content=`
              <div style="text-align:center;padding:40px;">
                <div style="font-size:64px;margin-bottom:20px;">📄</div>
                <div>PDF файл: ${doc.name}</div>
                <div style="margin-top:10px;color:var(--text-secondary);font-size:14px;">
                  Размер: ${this.formatFileSize(doc.size)}
                </div>
                <p style="margin-top:20px;color:var(--text-secondary);">
                  На мобильных устройствах PDF открывается через скачивание
                </p>
              </div>`;
          } else {
            content=`<embed src="${doc.data}" type="application/pdf"
                              style="width:100%;height:400px;">`;
          }
        } else if(doc.type==='txt'){
          try {
            const b64=doc.data.split(',')[1];
            const txt=atob(b64);
            const decoded=decodeURIComponent(escape(txt));
            content=`<pre style="background:var(--bg-card);
                               padding:20px;border-radius:12px;
                               overflow:auto;max-height:400px;
                               white-space:pre-wrap;">
                        ${decoded}
                     </pre>`;
          } catch {
            content=`<div style="text-align:center;padding:40px;">
                        Ошибка при чтении файла
                     </div>`;
          }
        } else {
          content=`<div style="text-align:center;padding:40px;">
                      <div style="font-size:64px;margin-bottom:20px;">
                        ${this.getFileIcon(doc.type)}
                      </div>
                      <div>Предпросмотр недоступен</div>
                    </div>`;
        }
        m.innerHTML=`
          <div class="modal-content" style="max-width:600px;">
            <div class="modal-header">
              <h2 class="modal-title">${doc.name}</h2>
              <button class="modal-close" onclick="this.closest('.modal').remove()">✕</button>
            </div>
            <div style="margin:20px 0;">${content}</div>
            <div style="display:flex;gap:10px;">
              ${doc.type==='pdf'&&/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)?
                `<button class="btn btn-primary"
                         onclick="app.openPdfInNewTab('${doc.data}','${doc.name}')">
                   <span>👁️</span> Просмотр
                 </button>`:''}
              <button class="btn btn-primary"
                      onclick="app.downloadDocument('${doc.id}')">
                <span>💾</span> Скачать
              </button>
              <button class="btn btn-secondary"
                      onclick="app.shareDocument('${doc.id}')">
                <span>📤</span> Поделиться
              </button>
              <button class="btn btn-secondary"
                      style="background:var(--danger);"
                      onclick="app.deleteDocument('${doc.id}');this.closest('.modal').remove()">
                <span>🗑️</span> Удалить
              </button>
            </div>
          </div>`;
        document.body.appendChild(m);
      },

      showFullscreenImage(src){
        const f=document.createElement('div');
        f.className='fullscreen-image';
        f.innerHTML=`
          <img src="${src}" alt="Fullscreen">
          <button class="fullscreen-close" onclick="this.parentElement.remove()">✕</button>`;
        f.onclick=e=>{ if(e.target===f) f.remove(); };
        document.body.appendChild(f);
      },

      openPdfInNewTab(data,name){
        const w=window.open();
        w.document.write(`
          <!DOCTYPE html><html><head>
            <title>${name}</title>
            <meta name="viewport" content="width=device-width,initial-scale=1.0">
            <style>body{margin:0;padding:0;overflow:hidden}iframe{width:100vw;height:100vh;border:none}</style>
          </head><body>
            <iframe src="${data}"></iframe>
          </body></html>`);
      },

      async downloadDocument(id){
        const tx=this.db.transaction(['documents','vault'],'readonly');
        const ds=tx.objectStore('documents');
        const req=ds.get(id);
        req.onsuccess=()=>{
          let d=req.result;
          if(d) this.performDownload(d);
          else {
            const vs=tx.objectStore('vault');
            const r2=vs.get(id);
            r2.onsuccess=()=>{ if(r2.result) this.performDownload(r2.result); };
          }
        };
      },

      async performDownload(doc){
        if(doc.type==='pdf'&&/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)){
          this.openPdfInNewTab(doc.data,doc.name);
          return;
        }
        if('showSaveFilePicker' in window){
          this.saveWithFileSystemAPI(doc);
        } else {
          const a=document.createElement('a');
          a.href=doc.data; a.download=doc.name; a.click();
        }
      },

      async saveWithFileSystemAPI(doc){
        try {
          const handle=await window.showSaveFilePicker({
            suggestedName:doc.name,
            types:[{description:'File',accept:{'*/*':[`.${doc.type}`]}}]
          });
          const writable=await handle.createWritable();
          const res=await fetch(doc.data);
          const blob=await res.blob();
          await writable.write(blob);
          await writable.close();
          this.showToast('Файл сохранен');
        } catch(err){
          if(err.name!=='AbortError'){
            console.error(err);
            const a=document.createElement('a');
            a.href=doc.data; a.download=doc.name; a.click();
          }
        }
      },

      async deleteDocument(id){
        if(!confirm('Удалить документ?')) return;
        const tx=this.db.transaction(['documents','vault'],'readwrite');
        tx.objectStore('documents').delete(id);
        tx.objectStore('vault').delete(id);
        this.showToast('Документ удален');
        setTimeout(()=>this.render(),200);
      },

      async shareDocument(id){
        const tx=this.db.transaction(['documents','vault'],'readonly');
        const ds=tx.objectStore('documents');
        const req=ds.get(id);
        req.onsuccess=async()=>{
          let d=req.result;
          if(!d){
            const vs=tx.objectStore('vault');
            const r2=vs.get(id);
            r2.onsuccess=async()=>{
              if(r2.result) await this.performShare(r2.result);
            };
          } else await this.performShare(d);
        };
      },

      async performShare(doc){
        if(navigator.share){
          try {
            const res=await fetch(doc.data);
            const blob=await res.blob();
            const file=new File([blob],doc.name,{type:blob.type});
            await navigator.share({files:[file],title:doc.name});
          } catch(err){
            if(err.name!=='AbortError') this.showToast('Ошибка при отправке');
          }
        } else this.showToast('Функция не поддерживается');
      },

      sortDocuments(){
        this.sortBy=this.sortBy==='date'?'type':'date';
        this.showToast(`Сортировка по ${this.sortBy==='date'?'дате':'типу'}`);
        this.render();
      },

      showNewFolderModal(){
        this.showModal('newFolderModal');
        document.getElementById('folderName').value='';
      },

      async createFolder(){
        const v=document.getElementById('folderName').value.trim();
        if(!v){ this.showToast('Введите название папки');return; }
        const f={id:Date.now()+'_'+Math.random(),name:v,created:Date.now()};
        const tx=this.db.transaction(['folders'],'readwrite');
        await tx.objectStore('folders').add(f);
        this.closeModal('newFolderModal');
        this.showToast('Папка создана');
        this.render();
      },

      async getFolders(){
        return new Promise((res,rej)=>{
          const tx=this.db.transaction(['folders'],'readonly');
          const req=tx.objectStore('folders').getAll();
          req.onsuccess=()=>res(req.result);
          req.onerror=()=>rej(req.error);
        });
      },

      openFolder(id){
        this.currentFolder=id;
        this.render();
      },

      async deleteFolder(id){
        if(!confirm('Удалить папку? Все документы из папки переместятся в главную.')) return;
        const docs=await this.getDocuments();
        const df=docs.filter(d=>d.folder===id);
        for(const d of df){
          d.folder=null;
          const tx=this.db.transaction(['documents'],'readwrite');
          await tx.objectStore('documents').put(d);
        }
        const tx=this.db.transaction(['folders'],'readwrite');
        await tx.objectStore('folders').delete(id);
        this.showToast('Папка удалена');
        this.render();
      },

      openVault(){
        if(!this.vaultUnlocked) this.showPinModal();
        else this.showVaultContents();
      },

      showPinModal(){
        this.showModal('pinModal');
        this.clearPinInputs();
      },

      goHome(){
        this.currentFolder=null;
        this.render();
      },

      showVaultContents(){
        this.currentFolder='vault';
        this.render();
      },

      async getSettings(){
        return new Promise((res,rej)=>{
          const tx=this.db.transaction(['settings'],'readonly');
          const req=tx.objectStore('settings').getAll();
          req.onsuccess=()=>res(req.result);
          req.onerror=()=>rej(req.error);
        });
      },

      showImportModal(){
        const inp=document.createElement('input');
        inp.type='file';inp.accept='.json';
        inp.onchange=async e=>{
          const f=e.target.files[0];
          if(!f) return;
          const r=new FileReader();
          r.onload=async ev=>{
            try {
              const data=JSON.parse(ev.target.result);
              await this.importData(data);
              this.showToast('Данные импортированы');
              this.render();
            } catch(err){
              this.showToast('Ошибка импорта');
              console.error(err);
            }
          };
          r.readAsText(f);
        };
        inp.click();
        this.closeModal('menuModal');
      },

      async importData(data){
        await this.clearAllData();
        if(data.folders){
          const tx=this.db.transaction(['folders'],'readwrite');
          for(const f of data.folders)
            await tx.objectStore('folders').add(f);
        }
        if(data.documents){
          const tx=this.db.transaction(['documents'],'readwrite');
          for(const d of data.documents)
            await tx.objectStore('documents').add(d);
        }
        if(data.vault){
          const tx=this.db.transaction(['vault'],'readwrite');
          for(const d of data.vault)
            await tx.objectStore('vault').add(d);
        }
        if(data.settings){
          const tx=this.db.transaction(['settings'],'readwrite');
          for(const s of data.settings)
            await tx.objectStore('settings').put(s);
        }
      },

      showClearDataModal(){
        if(confirm('Удалить все данные? Это действие необратимо!')){
          this.clearAllData();
          this.showToast('Все данные удалены');
          this.render();
        }
        this.closeModal('menuModal');
      },

      async clearAllData(){
        for(const s of ['documents','folders','vault','settings']){
          const tx=this.db.transaction([s],'readwrite');
          await tx.objectStore(s).clear();
        }
        this.currentFolder=null;
        this.vaultUnlocked=false;
      },

      emergencyWipe(){
        this.clearAllData();
        this.closeModal('pinModal');
        this.showToast('Экстренная очистка выполнена');
        this.render();
      },

      setupContextMenu(){
        document.addEventListener('click',e=>{
          const m=document.getElementById('contextMenu');
          if(!m.contains(e.target)) m.classList.remove('active');
        });
      },

      showDocumentMenu(e,id){
        e.preventDefault();
        this.contextMenuTarget=id;
        const m=document.getElementById('contextMenu');
        m.style.left=e.pageX+'px';
        m.style.top=e.pageY+'px';
        m.classList.add('active');
      },

      showFolderMenu(e,id){
        e.preventDefault();
        this.contextMenuTarget=id;
        const m=document.getElementById('contextMenu');
        m.style.left=e.pageX+'px';
        m.style.top=e.pageY+'px';
        m.classList.add('active');
      },

      contextMenuAction(act){
        const id=this.contextMenuTarget;
        document.getElementById('contextMenu').classList.remove('active');
        switch(act){
          case 'open': this.openDocument(id); break;
          case 'download': this.downloadDocument(id); break;
          case 'share': this.shareDocument(id); break;
          case 'delete': this.deleteDocument(id); break;
        }
      },

      showModal(id){
        document.getElementById(id).classList.add('active');
      },

      closeModal(id){
        document.getElementById(id).classList.remove('active');
        if(id==='pinModal') this.clearPinInputs();
      },

      showMenu(){
        this.showModal('menuModal');
      },

      showUploadModal(){
        this.showModal('uploadModal');
        document.getElementById('fileInput').value='';
      },

      showAbout(){
        alert('Secure Vault v1.0\n\nЗащищенное хранилище документов\n\n© 2024');
        this.closeModal('menuModal');
      },

      showToast(msg){ 
        const t=document.getElementById('toast');
        t.textContent=msg; t.classList.add('show');
        setTimeout(()=>t.classList.remove('show'),3000);
      },

      updateFolderSelector(){
        this.getFolders().then(f=>{
          let opts='<option value="">Главная</option><option value="vault">🔐 Сейф</option>';
          f.forEach(x=>opts+=`<option value="${x.id}">${x.name}</option>`);
          document.getElementById('folderSelect').innerHTML=opts;
        });
      },

      getFileIcon(type){
        const m={pdf:'📄',doc:'📝',docx:'📝',xls:'📊',xlsx:'📊',
                 txt:'📃',jpg:'🖼️',jpeg:'🖼️',png:'🖼️',gif:'🖼️'};
        return m[type]||'📎';
      },

      getFileType(fn){ return fn.split('.').pop().toLowerCase(); },

      formatFileSize(b){
        if(b===0) return '0 Bytes';
        const k=1024,s=['Bytes','KB','MB','GB'],
              i=Math.floor(Math.log(b)/Math.log(k));
        return Math.round(b/Math.pow(k,i)*100)/100+' '+s[i];
      }
    };

    document.addEventListener('DOMContentLoaded',()=>app.init());

    // Отключение зума при двойном тапе
    let lastTouchEnd=0;
    document.addEventListener('touchend',e=>{
      const now=Date.now();
      if(now-lastTouchEnd<=300) e.preventDefault();
      lastTouchEnd=now;
    },false);
  </script>
</body>
</html>
